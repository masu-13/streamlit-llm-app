import os
import streamlit as st
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain.schema import HumanMessage, SystemMessage

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")

# å°‚é–€å®¶ã®ç¨®é¡ã¨ãã‚Œãã‚Œã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®šç¾©
EXPERT_ROLES = {
    "ãƒ“ã‚¸ãƒã‚¹ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ": "ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ“ã‚¸ãƒã‚¹ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚çµŒå–¶æˆ¦ç•¥ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã€çµ„ç¹”é‹å–¶ãªã©ã«ã¤ã„ã¦å°‚é–€çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚",
    "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å°‚é–€å®¶": "ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ã¤ã„ã¦æŠ€è¡“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚",
    "åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼": "ã‚ãªãŸã¯åŒ»ç™‚åˆ†é‡ã®å°‚é–€å®¶ã§ã™ã€‚å¥åº·ç®¡ç†ã€äºˆé˜²åŒ»å­¦ã€ä¸€èˆ¬çš„ãªåŒ»ç™‚æƒ…å ±ã«ã¤ã„ã¦åŠ©è¨€ã‚’æä¾›ã—ã¾ã™ã€‚ï¼ˆâ€»è¨ºæ–­ã‚„æ²»ç™‚è¡Œç‚ºã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰",
    "æ•™è‚²ã‚³ãƒ¼ãƒ": "ã‚ãªãŸã¯æ•™è‚²ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã™ã€‚å­¦ç¿’æ–¹æ³•ã€æ•™è‚²ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã€ç”Ÿå¾’ã®æˆé•·æ”¯æ´ã«ã¤ã„ã¦å°‚é–€çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚",
    "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°å°‚é–€å®¶": "ã‚ãªãŸã¯ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®å°‚é–€å®¶ã§ã™ã€‚åºƒå‘Šæˆ¦ç•¥ã€SNSæ´»ç”¨ã€ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€é¡§å®¢ç²å¾—ã«ã¤ã„ã¦å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚"
}

def get_llm_response(user_input: str, expert_type: str) -> str:
    """
    LLMã‹ã‚‰ã®å›ç­”ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    
    Args:
        user_input (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
        expert_type (str): é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã®ç¨®é¡
    
    Returns:
        str: LLMã‹ã‚‰ã®å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ
    """
    try:
        # ChatOpenAIã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        chat = ChatOpenAI(
            model="gpt-3.5-turbo",
            temperature=0.7,
            openai_api_key=api_key
        )
        
        # ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        system_message = SystemMessage(content=EXPERT_ROLES[expert_type])
        human_message = HumanMessage(content=user_input)
        
        # LLMã«å•ã„åˆã‚ã›
        response = chat.invoke([system_message, human_message])
        
        return response.content
    
    except Exception as e:
        return f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"

# Streamlitã‚¢ãƒ—ãƒªã®ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†
def main():
    # ãƒšãƒ¼ã‚¸è¨­å®š
    st.set_page_config(
        page_title="AIå°‚é–€å®¶ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
        page_icon="ğŸ¤–",
        layout="wide"
    )
    
    # ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜
    st.title("ğŸ¤– AIå°‚é–€å®¶ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ")
    st.markdown("---")
    
    # ã‚¢ãƒ—ãƒªã®æ¦‚è¦
    st.markdown("""
    ### ğŸ“– ã‚¢ãƒ—ãƒªã®æ¦‚è¦
    ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€æ§˜ã€…ãªåˆ†é‡ã®å°‚é–€å®¶ã¨ã—ã¦AIã«ç›¸è«‡ã§ãã¾ã™ã€‚
    å°‚é–€å®¶ã®ç¨®é¡ã‚’é¸æŠã—ã€è³ªå•ã‚„ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€é¸æŠã—ãŸå°‚é–€å®¶ã®è¦–ç‚¹ã‹ã‚‰å›ç­”ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
    
    ### ğŸ”§ æ“ä½œæ–¹æ³•
    1. **å°‚é–€å®¶ã‚’é¸æŠ**: ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‹ã‚‰ç›¸è«‡ã—ãŸã„åˆ†é‡ã®å°‚é–€å®¶ã‚’é¸ã‚“ã§ãã ã•ã„
    2. **è³ªå•ã‚’å…¥åŠ›**: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è³ªå•ã‚„ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
    3. **å›ç­”ã‚’å–å¾—**: ã€Œå›ç­”ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€AIãŒå°‚é–€å®¶ã¨ã—ã¦å›ç­”ã—ã¾ã™
    """)
    
    st.markdown("---")
    
    # 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.subheader("âš™ï¸ è¨­å®š")
        # å°‚é–€å®¶ã®ç¨®é¡ã‚’é¸æŠã™ã‚‹ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
        expert_type = st.radio(
            "å°‚é–€å®¶ã®ç¨®é¡ã‚’é¸æŠ:",
            options=list(EXPERT_ROLES.keys()),
            help="ç›¸è«‡ã—ãŸã„åˆ†é‡ã®å°‚é–€å®¶ã‚’é¸ã‚“ã§ãã ã•ã„"
        )
        
        st.info(f"**é¸æŠä¸­**: {expert_type}")
    
    with col2:
        st.subheader("ğŸ’¬ è³ªå•ãƒ»ç›¸è«‡")
        # å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
        user_input = st.text_area(
            "è³ªå•ã‚„ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",
            height=150,
            placeholder="ã“ã“ã«è³ªå•ã‚„ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
        )
        
        # é€ä¿¡ãƒœã‚¿ãƒ³
        if st.button("ğŸš€ å›ç­”ã‚’å–å¾—", type="primary"):
            if user_input.strip():
                with st.spinner("AIãŒè€ƒãˆã¦ã„ã¾ã™..."):
                    # LLMã‹ã‚‰å›ç­”ã‚’å–å¾—
                    response = get_llm_response(user_input, expert_type)
                    
                    # å›ç­”ã‚’è¡¨ç¤º
                    st.markdown("---")
                    st.subheader("âœ¨ å›ç­”")
                    st.markdown(response)
            else:
                st.warning("âš ï¸ è³ªå•ã‚„ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

if __name__ == "__main__":
    main()


